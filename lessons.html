<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Future Perfect ‚Äì Lessons</title>

  <style>
    :root{
      --red:#d71920;
      --blue:#0b2a6f;
      --border:#e7e7e7;
      --text:#111;
      --muted:#666;
      --bg:#ffffff;
    }

    *{ box-sizing:border-box; }

    body{
      margin:0;
      padding:24px;
      font-family:"Segoe UI", Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .frame{
      max-width:1200px;
      margin:0 auto;
      padding:10px;
      border-radius:22px;
      background:repeating-linear-gradient(
        45deg,
        var(--red) 0 14px,
        #fff 14px 28px,
        var(--blue) 28px 42px,
        #fff 42px 56px
      );
    }

    .panel{
      background:#fff;
      border-radius:18px;
      padding:20px;
      border:1px solid var(--border);
    }

    /* --- TOP STACK (logo, title, buttons) --- */
    .logoRow{
      display:flex;
      align-items:center;
      justify-content:flex-start;
      margin-bottom:10px;
    }

    .logo{
      height:48px;
      width:auto;
      display:block;
    }

    .titleRow{
      display:flex;
      flex-direction:column;
      gap:4px;
      margin-bottom:14px;
    }

    h1{
      margin:0;
      font-size:28px;
      line-height:1.2;
      letter-spacing:-0.2px;
    }

    .sub{
      margin:0;
      color:var(--muted);
      font-size:14px;
    }

    .actionRow{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin:14px 0 16px 0;
      flex-wrap:wrap;
    }

    .btn{
      border:1px solid var(--border);
      background:#fff;
      padding:10px 14px;
      border-radius:12px;
      font-weight:700;
      cursor:pointer;
      text-decoration:none;
      color:var(--text);
      user-select:none;
      display:inline-flex;
      align-items:center;
      gap:8px;
    }

    .btn.primary{
      background:var(--blue);
      color:#fff;
      border-color:transparent;
    }

    .btn:active{ transform:translateY(1px); }

    /* --- SEARCH --- */
    .searchWrap{
      position:relative;
      margin-bottom:18px;
    }

    .searchIcon{
      position:absolute;
      top:50%;
      left:14px;
      transform:translateY(-50%);
      font-size:18px;
      color:var(--muted);
      pointer-events:none;
    }

    .searchInput{
      width:100%;
      padding:14px 16px 14px 44px;
      border-radius:14px;
      border:1px solid var(--border);
      font-size:15px;
      outline:none;
    }

    .searchInput:focus{
      border-color:#cfcfcf;
      box-shadow:0 0 0 4px rgba(11,42,111,0.08);
    }

    /* --- LIST --- */
    .list{
      display:grid;
      gap:14px;
    }

    .card{
      border:1px solid var(--border);
      border-radius:16px;
      padding:16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      background:#fff;
    }

    .lessonTitle{
      font-size:18px;
      font-weight:800;
      line-height:1.25;
    }

    /* --- PLAYER --- */
    .playerWrap{
      margin-top:20px;
      border:1px solid var(--border);
      border-radius:18px;
      overflow:hidden;
      display:none;
      background:#fff;
    }

    .playerHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      padding:12px 14px;
      border-bottom:1px solid var(--border);
    }

    .playerTitle{
      font-weight:900;
      min-width:0;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .playerBox{
      position:relative;
      width:100%;
      padding-top:56.25%;
      background:#000;
    }

    iframe{
      position:absolute;
      top:0; left:0;
      width:100%;
      height:100%;
      border:0;
    }

    /* --- MESSAGES --- */
    .error{
      margin:14px 0 0 0;
      padding:14px;
      border-radius:14px;
      background:#fff4f4;
      border:1px solid #f0bcbc;
      color:#7a0b0b;
      font-weight:700;
      display:none;
    }

    .notice{
      margin-top:14px;
      font-size:12px;
      color:var(--muted);
      text-align:center;
      line-height:1.4;
    }
  </style>
</head>

<body>
  <div class="frame">
    <div class="panel">

      <div class="logoRow">
        <img src="assets/fpt-logo.png" class="logo" alt="Future Perfect Tuitions">
      </div>

      <div class="titleRow">
        <h1 id="heading">Lessons</h1>
        <p class="sub" id="sub">Loading‚Ä¶</p>
      </div>

      <div class="actionRow">
        <a id="backBtn" class="btn" href="chooser.html">‚Üê Back</a>
        <button id="logoutBtn" class="btn primary" type="button">Log out</button>
      </div>

      <div class="searchWrap">
        <div class="searchIcon">üîç</div>
        <input
          id="searchInput"
          class="searchInput"
          type="search"
          placeholder="Search lessons (e.g. Fractions, Algebra, BIDMAS)‚Ä¶"
          autocomplete="off"
        />
      </div>

      <div id="errorBox" class="error"></div>

      <div id="list" class="list" aria-live="polite"></div>

      <div id="playerWrap" class="playerWrap">
        <div class="playerHeader">
          <div class="playerTitle" id="playerTitle">Lesson</div>
          <button id="closePlayerBtn" class="btn" type="button">Close</button>
        </div>
        <div class="playerBox">
          <iframe id="player" allowfullscreen="true" scrolling="no"></iframe>
        </div>
      </div>

      <div class="notice">
        üîí Videos are proprietary material belonging to Future Perfect Tuitions.
        These must not be shared, copied, or distributed outside of Future Perfect Tuitions.
        <br><br>
        Access is provided only while the child is enrolled and will be withdrawn once the student is no longer on roll.
      </div>

    </div>
  </div>

<script>
(() => {
  // TEST Worker API (your frosty-rain worker)
  const API = "https://frosty-rain-828e.futureperfectlessons.workers.dev";

  const qs = new URLSearchParams(location.search);

  // IMPORTANT: we now support both Maths + VR branches
  // - mode=maths (default)  year=Y4/Y5/Y6/Y411plus/Y511plus
  // - mode=vr               year=VR_HOWTO / VR_Y4 / VR_Y5   (these are "lesson buckets" in KV)
  const mode = (qs.get("mode") || "maths").trim().toLowerCase();
  const year = (qs.get("year") || "").trim();
  const baseYear = (qs.get("baseYear") || "").trim(); // used only to build the correct "Back" link for VR

  const heading = document.getElementById("heading");
  const sub = document.getElementById("sub");
  const list = document.getElementById("list");
  const err = document.getElementById("errorBox");
  const search = document.getElementById("searchInput");

  const backBtn = document.getElementById("backBtn");
  const logoutBtn = document.getElementById("logoutBtn");

  const playerWrap = document.getElementById("playerWrap");
  const player = document.getElementById("player");
  const playerTitle = document.getElementById("playerTitle");
  const closePlayerBtn = document.getElementById("closePlayerBtn");

  let lessons = [];

  function showError(msg){
    err.style.display = "block";
    err.textContent = msg;
  }
  function clearError(){
    err.style.display = "none";
    err.textContent = "";
  }

  function yearLabelToFull(y){
    const m = /^Y(\d+)$/.exec(y);
    return m ? `Year ${m[1]}` : y;
  }

  function bucketLabel(){
    // Nice heading labels depending on mode/year
    if (mode === "vr"){
      if (year === "VR_HOWTO") return "Verbal Reasoning ‚Äì How to";
      if (year === "VR_Y4") return "Verbal Reasoning ‚Äì Year 4";
      if (year === "VR_Y5") return "Verbal Reasoning ‚Äì Year 5";
      return "Verbal Reasoning";
    }
    // maths
    return `Lessons ‚Äì ${yearLabelToFull(year)}`;
  }

  function screenpalUrl(spId){
    const id = encodeURIComponent(spId);
    return `https://go.screenpal.com/player/${id}?ff=1&ahc=1&dcc=1&bg=transparent`;
  }

  function openLesson(lesson){
    playerTitle.textContent = lesson.title || "Lesson";
    player.src = screenpalUrl(lesson.sp);
    playerWrap.style.display = "block";
    playerWrap.scrollIntoView({ behavior:"smooth", block:"start" });
  }

  function closePlayer(){
    player.src = "about:blank";
    playerWrap.style.display = "none";
  }

  function getAuth(){
    const u = (sessionStorage.getItem("fpt_u") || "").trim();
    const p = (sessionStorage.getItem("fpt_p") || "").trim();
    if(!u || !p) return null;
    return { u, header: "Basic " + btoa(u + ":" + p) };
  }

  function logout(){
    sessionStorage.removeItem("fpt_u");
    sessionStorage.removeItem("fpt_p");
    location.href = "index.html";
  }

  function setBackLink(){
    // Maths path:
    //   login -> chooser.html -> subject.html?year=Y4 -> lessons.html?year=Y4&mode=maths
    // so back should go to subject.html?year=Y4
    if (mode !== "vr"){
      backBtn.textContent = "‚Üê Back";
      backBtn.href = `subject.html?year=${encodeURIComponent(year)}`;
      return;
    }

    // VR path:
    //   login -> chooser.html -> subject.html?year=Y4 -> (VR) chooser.html?mode=vr&baseYear=Y4 -> lessons.html?year=VR_HOWTO&mode=vr&baseYear=Y4
    // so back should go to chooser.html?mode=vr&baseYear=...
    backBtn.textContent = "‚Üê Back";
    backBtn.href = `chooser.html?mode=vr&baseYear=${encodeURIComponent(baseYear || "")}`;
  }

  function render(){
    const q = (search.value || "").trim().toLowerCase();
    const filtered = lessons.filter(l => (l.title || "").toLowerCase().includes(q));

    list.innerHTML = "";

    if (!filtered.length){
      const empty = document.createElement("div");
      empty.className = "card";
      empty.innerHTML = `<div class="lessonTitle">No matching lessons</div>`;
      list.appendChild(empty);
      return;
    }

    filtered.forEach(l => {
      const card = document.createElement("div");
      card.className = "card";

      const left = document.createElement("div");
      left.className = "lessonTitle";
      left.textContent = l.title || "Lesson";

      const btn = document.createElement("button");
      btn.className = "btn primary";
      btn.type = "button";
      btn.textContent = "Open lesson";
      btn.disabled = !l.sp;

      btn.addEventListener("click", () => openLesson(l));

      card.appendChild(left);
      card.appendChild(btn);
      list.appendChild(card);
    });
  }

  async function load(){
    clearError();
    closePlayer();

    const auth = getAuth();
    if(!auth){
      location.href = "index.html";
      return;
    }

    if (!year){
      heading.textContent = "Lessons";
      sub.textContent = "Missing link details.";
      showError("Use a link like: lessons.html?year=Y6&mode=maths");
      return;
    }

    heading.textContent = bucketLabel();
    setBackLink();
    sub.textContent = `Loading lessons for ${auth.u}‚Ä¶`;

    const url = new URL(API + "/lessons");
    url.searchParams.set("year", year);

    const res = await fetch(url.toString(), {
      method: "GET",
      headers: { "Authorization": auth.header }
    });

    if(!res.ok){
      showError(`Failed to load lessons (${res.status}).`);
      sub.textContent = "Could not load lessons.";
      if (res.status === 401) logout();
      return;
    }

    const data = await res.json();
    if(!Array.isArray(data)){
      showError("API returned unexpected data.");
      sub.textContent = "Could not load lessons.";
      return;
    }

    lessons = data;
    sub.textContent = `Showing ${lessons.length} lesson(s) for ${auth.u}.`;
    render();
  }

  search.addEventListener("input", render);
  closePlayerBtn.addEventListener("click", closePlayer);
  logoutBtn.addEventListener("click", logout);

  load();
})();
</script>
</body>
</html>
